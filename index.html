<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css" />
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.3.3/css/searchPanes.dataTables.min.css"/>
    <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/dataTables.searchPanes.min.js"></script>
    <script>
        $(document).ready(function() {
            let favoriteDogs = [];
            let searchTable = new DataTable('#searchTable', {
                select: true,
                paging: true,
                searching: true,
                ordering: true,
                info: false,
                autoWidth: false,
                columnDefs: [
                    { targets: 0, orderable: false, render:    
                        function (data){
                            return '<input type="checkbox" id="favCheck" value="' + $('<div/>').text(data).html() + '">';
                        }
                    },
                    { targets: 1, orderable: false }, 
                    { targets: 2, orderable: true },
                    { targets: 3, orderable: true }, 
                    { targets: 4, orderable: true },
                    { targets: 5, orderable: true },
                    { targets: 6, visible: false }
                ],
            });
            let favTable = new DataTable('#favTable', {
                paging: true,
                searching: true,
                ordering: true,
                info: false,
                autoWidth: false,
                columnDefs: [
                    {
                        targets: 0, orderable: false, render:
                            function (data) {
                                return '<input type="checkbox" id="unfavCheck" value="' + $('<div/>').text(data).html() + '">';
                            }
                    },
                    { targets: 1, orderable: false },
                    { targets: 2, orderable: true },
                    { targets: 3, orderable: true },
                    { targets: 4, orderable: true },
                    { targets: 5, orderable: true },
                    { targets: 6, visible: false }
                ],
            });
            
        });
    </script>
    <title>Fetch Login</title>

</head>
<body>
    <script type="text/javascript" src="js/logincheck.js"></script>
    <h1>Fetch Search Page</h1>
    <p id="loginresult">Please Login</p>
    <form id="loginForm">
        <div class="container" id="loginbox">
            <label for="uname"><b>Name</b></label>
            <input type="text" placeholder="Enter Name" id="uname" required>
        
            <label for="email"><b>Email</b></label>
            <input type="text" placeholder="Enter Email" id="email" required>
        
            <button type="submit">Login</button>
        </div>
    </form>
    <form id="searchForm">
        <div class="container" id="filterBox">
            <label for="breed">Breed</label>
            <select id="breedSelect">
            </select>
            <label for="zipcode">Zip Codes</label>
            <input type="text" id="zipCode" placeholder="Enter Zip Code">
            <p id="breedarray">Breeds: </p>
            <button type="button" id="breedClear">Clear Breeds</button>
            <p id="ziparray">Zip Codes: </p>
            <button type="button" id="zipClear">Clear Zips</button>
            <p>Minimum Age (yr)</p>
            <input type="range" min="0" max="100" value="1" class="slider" id="ageMin">
            <span id="ageMinValue">1</span>
            <script>
                document.getElementById('ageMin').addEventListener('input', function() {
                    document.getElementById('ageMinValue').innerText = this.value;
                });
            </script>
            <p>Maximum Age (yr)</p>
            <input type="range" min="0" max="100" value="10" class="slider" id="ageMax">
            <span id="ageMaxValue">10</span>
            <script>
                document.getElementById('ageMax').addEventListener('input', function() {
                    if (parseInt(this.value) < parseInt(document.getElementById('ageMin').value)) {
                        this.value = document.getElementById('ageMin').value;
                    }
                    document.getElementById('ageMaxValue').innerText = this.value;
                });
            </script>
        </div>
        <div class="container" id="searchbox">
            <table id="searchTable" class="display">
                <thead>
                    <tr>
                        <th>Favorite</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Zip Code</th>
                        <th>Breed</th>
                        <th>ID</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td>img</td>
                        <td>ADog</td>
                        <td>99</td>
                        <td>11111</td>
                        <td>Dog</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>img2</td>
                        <td>BDog</td>
                        <td>97</td>
                        <td>11112</td>
                        <td>NotDog</td>
                        <td>2</td>
                    </tr>
                </tbody>
                <tfoot>
                </tfoot>
            </table>
            <button type="submit" id="addFavBtn">Add to Favorites</button>
            <button type="submit" id="searchBtn">Search</button>
            <div class="pagination" id="pagebar"></div>
        </div>
</form>
    
    
    <h1>Favorites</h1>  
    <form id="favForm">
        <div class="container" id="favbox">
            <table id="favTable" class="display">
                <thead>
                    <tr>
                        <th>Unfavorite</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Zip Code</th>
                        <th>Breed</th>
                        <th>ID</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td>img3</td>
                        <td>CDog</td>
                        <td>9</td>
                        <td>99999</td>
                        <td>Cat</td>
                        <td>3</td>
                    </tr>
                </tbody>
            </table>
            <button type="submit" id="matchBtn">Match Me</button>
            <button type="submit" id="removeBtn">Remove from Favorites</button>
        </div>
    </form>
    

</body>
</html>
<script>
    const breedArray = [];
    const zipArray = [];
    //import DataTable from 'datatables.net-dt';
    function DogData(image, name, age, zip, breed, id) {
        this.image = image;
        this.name = name;
        this.age = age;
        this.zip = zip;
        this.breed = breed;
        this.id = id;
    }
    async function checkLogin(event) {
        event.preventDefault();
        const uname = document.getElementById('uname').value;
        const email = document.getElementById('email').value;

        const response = await fetch('https://frontend-take-home-service.fetch.com/auth/login', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: uname, email: email })
        });
        const result = await response;
        if (result.status == 200) {
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("searchForm").style.display = "block";
            document.getElementById("loginresult").innerHTML = "Login Successful!";
            const breeds = await getDogBreeds();
            const breedSelect = document.getElementById('breedSelect');
            breeds.forEach(breed => {
                const option = document.createElement('option');
                option.text = breed;
                breedSelect.add(option);
            });
        } else {
            document.getElementById("loginresult").innerHTML = "Invalid name or email";
        }
    }
    async function searchDogs() {
        const dogUrl = "https://frontend-take-home-service.fetch.com/dogs/search?" + new URLSearchParams({
            "breeds": breedArray,
            "zipCodes": zipArray,
            "ageMin": document.getElementById('ageMin').value,
            "ageMax": document.getElementById('ageMax').value,
        });
        const response = await fetch(dogUrl, {
            headers: {
                'Content-Type': 'application/json',
                'Cache': 'no-cache'
            },
            method: 'GET',
            credentials: 'include',
        })
        const result = await response;
        if (result.status !== 200) {
            throw new Error("Failed to fetch data");
        }
        return result.json;
    }

    async function getDogData(dogIdArray){
        const dogUrl = "https://frontend-take-home-service.fetch.com/dogs";
        console.log("DogIdArray: " + dogIdArray);
        console.log("DogIdArray as JSON: " + JSON.stringify(dogIdArray));
        const response = await fetch(dogUrl, {
            headers: {
                'Content-Type': 'application/json',
                'Cache': 'no-cache'
            },
            method: 'POST',
            credentials: 'include',
            body: JSON.stringify(dogIdArray)
        })
        const result = await response;
        if (result.status !== 200) {
            throw new Error("Failed to fetch data");
        }
        return result.json();

    }

    async function getDogBreeds() {
        const dogUrl = "https://frontend-take-home-service.fetch.com/dogs/breeds";
        const response = await fetch(dogUrl, {
            headers: {
                'Content-Type': 'application/json',
                'Cache': 'no-cache'
            },
            method: 'GET',
            credentials: 'include',
        })
        const result = await response;
        if (result.status !== 200) {
            throw new Error("Failed to fetch data");
        }
        return result.json();

    }

    function updateFavTable(dogDataArray) {
        const favTable = document.getElementById('favTable').getElementsByTagName('tbody')[0];
        favTable.innerHTML = ''; // Clear existing rows
        dogDataArray.forEach(dogData => {
            const row = createRow(dogData);
            favTable.appendChild(row);
        });
    }
    document.getElementById('loginForm').addEventListener('submit', checkLogin);
    document.getElementById('searchForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const button = event.submitter.id;

        if (button === "addFavBtn") {
            const selectedDogs = [];
            $('#searchTable tbody input[type="checkbox"]:checked').each(function() {
                const row = $(this).closest('tr');
                const rowData = $('#searchTable').DataTable().row(row.index()).data();
                console.log("Row found: " + $('#searchTable').DataTable().row(row.index()).data() + " " + row.index());
                console.log("Row data: " + rowData);
                $('#favTable').DataTable().row.add(rowData).draw();
            });
        }
        else if (button === "searchBtn") {
            const breed = document.getElementById('breedSelect').value;
            const zipCode = document.getElementById('zipCode').value;
            const dogIdArray = searchDogs().resultIds;
            const dogDataArray = getDogData(dogIdArray);
            console.log("DogDataArray: " + dogDataArray);
            // const searchTable = document.getElementById('searchTable').getElementsByTagName('tbody')[0];
            // searchTable.innerHTML = '';
            // dogDataArray.forEach(dogObj => {
            //     const row = createRow(dogObj);
            //     searchTable.appendChild(row);
            // });

        }

    });
    document.getElementById('favForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const button = event.submitter.id;

        if (button === "removeBtn") {
            $('#favTable tbody input[type="checkbox"]:checked').each(function () {
                $(this).prop('checked', false);
                const row = $(this).closest('tr');
                const rowData = $('#favTable').DataTable().row(row.index()).data();
                $('#favTable').DataTable().row(row.index()).remove().draw();
            });
        }
    });
    document.getElementById('breedSelect').addEventListener('change', function() {
        const breed = this.value;
        if (!breedArray.includes(breed)) {
            breedArray.push(breed);
            document.getElementById('breedarray').innerText = "Breeds: " + breedArray.join(", ");
        }
    });
    document.getElementById('zipCode').addEventListener('change', function() {
        const zip = this.value;
        if (!zipArray.includes(zip)) {
            zipArray.push(zip);
            document.getElementById('ziparray').innerText = "Zip Codes: " + zipArray.join(", ");
        }
    });
    document.getElementById('breedClear').addEventListener('click', function() {
        breedArray.length = 0;
        document.getElementById('breedarray').innerText = "Breeds: ";
    });
    document.getElementById('zipClear').addEventListener('click', function() {
        zipArray.length = 0;
        document.getElementById('ziparray').innerText = "Zip Codes: ";
    });
</script>